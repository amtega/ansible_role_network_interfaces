---
- name: Install 802.1q kernel module
  modprobe:
    name: 8021q
    state: present

- name: Disable ipv6
  sysctl:
    name: "{{ item }}"
    value: 1
    state: present
    reload: yes
  with_items:
    - net.ipv6.conf.all.disable_ipv6
    - net.ipv6.conf.default.disable_ipv6

- name: Remove ipv6 localhost from /etc/hosts
  lineinfile:
    dest: /etc/hosts
    regexp: '^\:\:1'
    state: absent

- name: Prevent udp rpcbind for ipv6
  replace:
    path: /etc/netconfig
    regexp: '^udp6'
    replace: '#udp6'
  when: ansible_distribution_major_version == "6"

- name: Prevent tcp rpcbind for ipv6
  replace:
    path: /etc/netconfig
    regexp: '^tcp6'
    replace: '#tcp6'
  when: ansible_distribution_major_version == "6"

- name: Icorpore vlan interfaces to definitive interfaces list
  set_fact:
    definitive_interfaces: "{{ definitiveinterfaces + |
                               [ item.logicalname ~ item.vlanid ] }}"
  with_items: nics
  when: item.vlanid is defined

- name: Remove old icfg-interface config config files
  file:
    path: "{{ network_scripts_path }}/ifcfg-{{ item }}"
    state: absent
  with_items: "{{ ansible_interfaces| difference(definitive_interfaces) }}"
  when: ansible_interfaces|difference(definitive_interfaces)|length > 0

- name: Create dns configuration file
  template:
    src: dns_config_template.j2
    dest: "{{ dns_config_file_path }}"

- name: Create a general network parameters file
  template:
    src: sysconfig_network_template.j2
    dest: "{{ sysconfig_network_file_path }}"
